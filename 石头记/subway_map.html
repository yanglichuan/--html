<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é«˜å¾·åœ°å›¾åœ°é“å›¾ API ç¤ºä¾‹</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-user-select: none;
            user-select: none;
            background: #f0f0f0; /* èƒŒæ™¯è‰²ï¼Œæ–¹ä¾¿çœ‹æ¸…è¾¹ç•Œ */
        }
        
        #mysubway {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #fff;
            /* å…³é”®ï¼šä½¿ç”¨ transform-origin: 0 0 é…åˆçŸ©é˜µè®¡ç®—æ¥å®ç°ç²¾ç¡®ç¼©æ”¾æ‹–åŠ¨ */
            transform-origin: 0 0;
            touch-action: none; /* ç¦ç”¨æµè§ˆå™¨é»˜è®¤æ‰‹åŠ¿ */
        }

        /* ç¼©æ”¾æ§åˆ¶æŒ‰é’® */
        .zoom-controls {
            position: absolute;
            bottom: 100px;
            right: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: none;
            font-size: 20px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .zoom-btn:active {
            background: #f0f0f0;
        }

        /* å°è¯•ä¿®å¤å¯èƒ½è¢«éšè—çš„å›¾æ ‡ */
        .amap-subway-icon, .subway-transfer {
            display: block !important;
            visibility: visible !important;
        }

        /* æ¡Œé¢ç«¯æ ·å¼ */
        .controls-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 999;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 260px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 800;
            color: #333;
        }

        .toggle-btn {
            display: none; /* æ¡Œé¢ç«¯éšè— */
            background: none;
            border: none;
            font-size: 20px;
            padding: 5px;
            color: #666;
        }

        .panel-content {
            display: block;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 500;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            appearance: none;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            background: #2980b9;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            active: scale(0.98);
        }

        button:active {
            opacity: 0.8;
        }

        .status-log {
            margin-top: 15px;
            font-size: 11px;
            color: #666;
            max-height: 80px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #eee;
            font-family: monospace;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .controls-panel {
                top: auto;
                bottom: 20px;
                left: 15px;
                right: 15px;
                width: auto;
                padding: 15px;
            }

            .controls-panel.collapsed {
                transform: translateY(calc(100% - 50px));
            }

            .toggle-btn {
                display: block;
            }

            .panel-header {
                margin-bottom: 10px;
            }
            
            /* å¢åŠ æŠ˜å æ—¶çš„ç‚¹å‡»åŒºåŸŸ */
            .panel-header::after {
                content: '';
                position: absolute;
                top: 0; left: 0; right: 0; height: 50px;
            }
        }
    </style>
</head>
<body>

    <div id="mysubway"></div>

    <div class="controls-panel" id="controlsPanel">
        <div class="panel-header" onclick="togglePanel()">
            <div class="panel-title">
                ğŸš‡ åœ°é“å›¾
                <span style="font-size:12px; font-weight:normal; color:#999; margin-left:5px" id="city-name-display">åŒ—äº¬</span>
            </div>
            <button class="toggle-btn" id="toggleIcon">â¬‡ï¸</button>
        </div>
        
        <div class="panel-content">
            <div class="form-group">
                <label>åˆ‡æ¢åŸå¸‚</label>
                <select id="city-select" onchange="changeCity()">
                    <option value="1100" selected>åŒ—äº¬</option>
                    <option value="3100">ä¸Šæµ·</option>
                    <option value="4401">å¹¿å·</option>
                    <option value="4403">æ·±åœ³</option>
                    <option value="3301">æ­å·</option>
                    <option value="3201">å—äº¬</option>
                    <option value="4201">æ­¦æ±‰</option>
                    <option value="5101">æˆéƒ½</option>
                    <option value="5000">é‡åº†</option>
                    <option value="1200">å¤©æ´¥</option>
                </select>
            </div>

            <div class="status-log" id="log-box">
                ç³»ç»Ÿå°±ç»ª...
            </div>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="handleZoom(1)">+</button>
        <button class="zoom-btn" onclick="handleZoom(-1)">-</button>
    </div>

    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '92bfe7a97139e681960bc243bcee5183',
        }
    </script>
    <script src="https://webapi.amap.com/subway?v=1.0&key=d15687a3a617417d4e5fba4a6927fe49&callback=cbk"></script>
    
    <script>
        let mySubway = null;
        let isReady = false;
        
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // --- æ‰‹åŠ¿ä¸å˜æ¢çŠ¶æ€ ---
        let state = {
            scale: 1,
            x: 0,
            y: 0
        };
        let lastTouch = { x: 0, y: 0, d: 0 };
        let isDragging = false;
        const el = document.getElementById('mysubway');

        // æ›´æ–°è§†å›¾å˜æ¢
        function updateTransform() {
            // ä½¿ç”¨ translate3d å¼€å¯ç¡¬ä»¶åŠ é€Ÿ
            el.style.transform = `translate3d(${state.x}px, ${state.y}px, 0) scale(${state.scale})`;
        }

        // æ ¸å¿ƒç¼©æ”¾å‡½æ•°ï¼šä»¥ (cx, cy) ä¸ºä¸­å¿ƒç¼©æ”¾
        function zoomTo(newScale, cx, cy) {
            // é™åˆ¶ç¼©æ”¾èŒƒå›´
            if (newScale < 0.5) newScale = 0.5;
            if (newScale > 5) newScale = 5;

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹çš„å˜åŒ–é‡
            const s = newScale / state.scale;

            // æ ¸å¿ƒç®—æ³•ï¼šä¿æŒ (cx, cy) åœ¨å…ƒç´ å†…çš„ç›¸å¯¹ä½ç½®ä¸å˜
            // æ–°åæ ‡ = ä¸­å¿ƒç‚¹ - (ä¸­å¿ƒç‚¹ - æ—§åæ ‡) * ç¼©æ”¾æ¯”ä¾‹
            state.x = cx - (cx - state.x) * s;
            state.y = cy - (cy - state.y) * s;
            state.scale = newScale;

            updateTransform();
            log(`ç¼©æ”¾: ${state.scale.toFixed(2)}`);
        }

        // --- äº‹ä»¶ç›‘å¬ ---

        // 1. è§¦æ‘¸å¼€å§‹
        el.addEventListener('touchstart', function(e) {
            if (e.touches.length === 1) {
                isDragging = true;
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            } else if (e.touches.length === 2) {
                isDragging = false;
                // è®¡ç®—ä¸¤æŒ‡è·ç¦»
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                lastTouch.d = Math.sqrt(dx * dx + dy * dy);
            }
            // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚æ»šåŠ¨ã€ç¼©æ”¾ï¼‰
            // æ³¨æ„ï¼šè¿™å¯èƒ½ä¼šé˜»æ­¢ç‚¹å‡»äº‹ä»¶ï¼ˆclickï¼‰ï¼Œä½†æˆ‘ä»¬éœ€è¦æ‹–åŠ¨ä¼˜å…ˆ
            // å¦‚æœéœ€è¦ç‚¹å‡»ç«™ç‚¹ï¼Œå¯èƒ½éœ€è¦åˆ¤æ–­ç§»åŠ¨è·ç¦»
            // e.preventDefault(); 
        }, { passive: false });

        // 2. è§¦æ‘¸ç§»åŠ¨
        el.addEventListener('touchmove', function(e) {
            e.preventDefault(); // å¿…é¡»é˜»æ­¢é»˜è®¤æ»šåŠ¨

            if (e.touches.length === 1 && isDragging) {
                // å•æŒ‡æ‹–åŠ¨
                const deltaX = e.touches[0].clientX - lastTouch.x;
                const deltaY = e.touches[0].clientY - lastTouch.y;
                
                state.x += deltaX;
                state.y += deltaY;
                
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
                
                updateTransform();

            } else if (e.touches.length === 2) {
                // åŒæŒ‡ç¼©æ”¾
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const currentD = Math.sqrt(dx * dx + dy * dy);

                if (lastTouch.d > 0) {
                    const center = {
                        x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
                        y: (e.touches[0].clientY + e.touches[1].clientY) / 2
                    };
                    
                    const zoomFactor = currentD / lastTouch.d;
                    const newScale = state.scale * zoomFactor;
                    
                    // ä½¿ç”¨åŒæŒ‡ä¸­å¿ƒè¿›è¡Œç¼©æ”¾
                    zoomTo(newScale, center.x, center.y);
                }
                lastTouch.d = currentD;
            }
        }, { passive: false });

        // 3. è§¦æ‘¸ç»“æŸ
        el.addEventListener('touchend', function(e) {
            isDragging = false;
            // å¦‚æœæ˜¯åŒæŒ‡å˜å•æŒ‡ï¼Œé‡ç½®ä¸€ä¸‹å•æŒ‡èµ·å§‹ç‚¹ï¼Œé˜²æ­¢è·³åŠ¨
            if (e.touches.length === 1) {
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
        });

        // æŒ‰é’®ç¼©æ”¾å¤„ç†
        function handleZoom(direction) {
            // ä»¥å±å¹•ä¸­å¿ƒä¸ºé”šç‚¹
            const cx = window.innerWidth / 2;
            const cy = window.innerHeight / 2;
            const newScale = state.scale + direction * 0.5;
            zoomTo(newScale, cx, cy);
        }

        // é¢æ¿äº¤äº’
        function togglePanel() {
            if (!isMobile) return;
            const panel = document.getElementById('controlsPanel');
            const icon = document.getElementById('toggleIcon');
            panel.classList.toggle('collapsed');
            icon.innerText = panel.classList.contains('collapsed') ? 'â¬†ï¸' : 'â¬‡ï¸';
        }

        // é»˜è®¤ç§»åŠ¨ç«¯æŠ˜å é¢æ¿
        if (isMobile) {
            document.getElementById('controlsPanel').classList.add('collapsed');
            document.getElementById('toggleIcon').innerText = 'â¬†ï¸';
        }

        function log(msg) {
            const box = document.getElementById('log-box');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            box.innerHTML = `<div style="margin-bottom:2px"><span style="color:#999">[${time}]</span> ${msg}</div>` + box.innerHTML;
        }

        window.cbk = function() {
            log("API Loaded. Init...");
            createSubway('1100');
        };

        function createSubway(adcode) {
            try {
                // æ›´æ–°UIæ˜¾ç¤º
                const select = document.getElementById('city-select');
                const cityName = select.options[select.selectedIndex].text;
                document.getElementById('city-name-display').innerText = cityName;

                // å…³é”®ä¿®æ­£ï¼šå°è¯•ä½¿ç”¨ client: 0 (PCæ¨¡å¼) æ¥è·å¾—æ›´å¥½çš„å…¼å®¹æ€§ï¼Œå› ä¸ºæ—§ç‰ˆç§»åŠ¨ç«¯æ¨¡å¼å¯èƒ½å·²è¿‡æ—¶
                const config = {
                    adcode: adcode,
                    // theme: "colorful", 
                    client: 0, // å¼ºåˆ¶ä½¿ç”¨ PC æ¨¡å¼ï¼Œé€šå¸¸èƒ½æ›´å¥½åœ°æ”¯æŒæ ‡å‡† Touch äº‹ä»¶
                    doubleclick: {
                        switch: true
                    }
                };

                // é‡ç½®å®¹å™¨å†…å®¹ä»¥é˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–å†²çªï¼ˆå¯é€‰ï¼‰
                // document.getElementById('mysubway').innerHTML = '';

                mySubway = subway("mysubway", config);
                
                mySubway.event.on("subway.complete", function(ev, info) {
                    isReady = true;
                    log(`åŠ è½½å®Œæˆ: ${cityName}`);
                });

                mySubway.event.on("station.touch", function(ev, info) {
                    const name = info.name;
                    const id = info.id;
                    log(`ç‚¹å‡»: ${name}`);
                    mySubway.setCenter(id);
                    mySubway.addInfoWindow(id, {});
                });

            } catch (e) {
                log("Err: " + e.message);
                console.error(e);
            }
        }

        function changeCity() {
            const adcode = document.getElementById('city-select').value;
            isReady = false;
            // é‡ç½®è§†å›¾
            state.scale = 1;
            state.x = 0;
            state.y = 0;
            updateTransform();
            
            createSubway(adcode);
        }

    </script>
</body>
</html>