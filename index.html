<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全A股实时联动对比系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinyin-match@1.2.5/dist/main.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #05070a;
            --sidebar-bg: #0c0f16;
            --card-bg: rgba(20, 24, 35, 0.8);
            --accent-color: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --up-color: #f43f5e;
            --down-color: #10b981;
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        [data-theme="light"] {
            --bg-color: #f1f5f9;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --accent-color: #2563eb;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --glass-border: rgba(0, 0, 0, 0.08);
        }

        [data-theme="gold"] {
            --bg-color: #1a1610;
            --sidebar-bg: #262118;
            --card-bg: #2d271d;
            --accent-color: #d4af37;
            --text-primary: #f5f1e6;
            --text-secondary: #a89f8d;
            --glass-border: rgba(212, 175, 55, 0.15);
        }

        [data-theme="emerald"] {
            --bg-color: #06110f;
            --sidebar-bg: #0b1f1c;
            --card-bg: #0f2925;
            --accent-color: #10b981;
            --text-primary: #ecfdf5;
            --text-secondary: #6ee7b7;
            --glass-border: rgba(16, 185, 129, 0.15);
        }

        .theme-control {
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 99px;
            border: 1px solid var(--glass-border);
        }

        .theme-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .theme-dot:hover {
            transform: scale(1.2);
        }

        .theme-dot.active {
            border-color: var(--text-primary);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', 'Noto Sans SC', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Stock List */
        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed {
            width: 0;
            opacity: 0;
            pointer-events: none;
            border-right: none;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .sound-toggle {
            cursor: pointer;
            padding: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            display: flex;
            transition: all 0.2s;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sound-toggle.muted {
            opacity: 0.4;
        }

        .search-box {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 0.6rem 1rem;
            color: white;
            outline: none;
            margin-top: 0.8rem;
        }

        .stock-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1rem;
            border-radius: 4px 8px 8px 4px;
            /* 侧边条效果 */
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            border-left-width: 4px;
            /* 预留侧边条宽度 */
            margin-bottom: 4px;
        }

        /* 上海：高清亮蓝 (SH) - 侧重主板稳健 */
        .item-sh {
            border-left: 6px solid #00a2ff;
            background: rgba(0, 162, 255, 0.15);
            border-bottom: 1px solid rgba(0, 162, 255, 0.2);
        }

        /* 深圳：鲜艳极速紫 (SZ) - 侧重成长 */
        .item-sz {
            border-left: 6px solid #e100ff;
            background: rgba(225, 0, 255, 0.12);
            border-bottom: 1px solid rgba(225, 0, 255, 0.2);
        }

        /* 北京：明锐金黄 (BJ) - 侧重启航 */
        .item-bj {
            border-left: 6px solid #ffcc00;
            background: rgba(255, 204, 0, 0.15);
            border-bottom: 1px solid rgba(255, 204, 0, 0.2);
        }

        .stock-item:hover {
            filter: brightness(1.2);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .stock-item.active {
            background: var(--accent-color) !important;
            border-left-color: white !important;
            color: white;
        }

        .stock-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stock-name-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stock-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .mkt-badge {
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 700;
            line-height: 1;
        }

        .mkt-sh {
            background: #00a2ff;
            color: #000;
        }

        .mkt-sz {
            background: #e100ff;
            color: #fff;
        }

        .mkt-bj {
            background: #ffcc00;
            color: #000;
        }

        .stock-code {
            font-size: 0.75rem;
            opacity: 0.6;
        }

        .stock-price {
            font-weight: 700;
            text-align: right;
        }

        .stock-pct {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
            padding: 0.2rem 0.5rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .refresh-pill {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 99px;
            font-size: 0.75rem;
            color: var(--accent-color);
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .stat-change {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .chart-box {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 0.6rem;
            margin-bottom: 0.5rem;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .up {
            color: var(--up-color);
        }

        .down {
            color: var(--down-color);
        }

        .neutral {
            color: var(--text-secondary);
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2 style="font-size: 1.1rem; font-weight: 700;">沪深京实时行情</h2>
            <input type="text" class="search-box" placeholder="搜索代码/拼音..." id="stock-search">
        </div>
        <div class="stock-list" id="stock-list">
            <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">加载榜单中...</div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <header>
                <div class="brand">
                    <div id="sidebar-toggle"
                        style="cursor: pointer; padding: 6px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; display: flex; transition: all 0.2s;">
                        <i data-lucide="menu" size="20" color="#3b82f6"></i>
                    </div>
                    <div style="background: var(--accent-color); padding: 6px; border-radius: 8px; display: flex;"><i
                            data-lucide="activity" color="white" size="20"></i></div>
                    <div>
                        <h1 style="font-size: 1.1rem; font-weight: 700;" id="main-title">神农集团 对标分析</h1>
                        <p style="font-size: 0.7rem; color: var(--text-secondary);">全维度联动 K 线 / 成交量 / 分时</p>
                    </div>
                </div>

                <div style="flex: 1;"></div>

                <div class="header-actions" style="display: flex; gap: 16px; align-items: center;">
                    <div class="refresh-pill">
                        <span id="last-update">--:--:--</span>
                    </div>

                    <div class="control-center"
                        style="display: flex; gap: 10px; align-items: center; background: rgba(255, 255, 255, 0.05); padding: 5px 10px; border-radius: 12px; border: 1px solid var(--glass-border); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div id="sound-toggle" class="sound-toggle" title="音效开关"
                            style="cursor: pointer; display: flex;">
                            <i data-lucide="volume-2" size="18" color="var(--text-secondary)"></i>
                        </div>

                        <div style="width: 1px; height: 16px; background: var(--glass-border); margin: 0 4px;"></div>

                        <div class="theme-control" style="display: flex; gap: 8px;">
                            <div class="theme-dot active"
                                style="background: #0c0f16; width: 14px; height: 14px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                                onclick="changeTheme('dark', this)" title="极客黑"></div>
                            <div class="theme-dot"
                                style="background: #ffffff; width: 14px; height: 14px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                                onclick="changeTheme('light', this)" title="明亮白"></div>
                            <div class="theme-dot"
                                style="background: #d4af37; width: 14px; height: 14px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                                onclick="changeTheme('gold', this)" title="土豪金"></div>
                            <div class="theme-dot"
                                style="background: #10b981; width: 14px; height: 14px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                                onclick="changeTheme('emerald', this)" title="祖母绿"></div>
                        </div>

                        <div style="width: 1px; height: 16px; background: var(--glass-border); margin: 0 4px;"></div>

                        <div id="latest-toggle"
                            style="cursor: pointer; padding: 4px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 6px; display: flex; transition: all 0.2s;"
                            title="跳转至最新">
                            <i data-lucide="chevrons-right" size="16" color="#3b82f6"></i>
                        </div>

                        <div id="fs-toggle"
                            style="cursor: pointer; padding: 4px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 6px; display: flex;"
                            title="切换全屏">
                            <i data-lucide="maximize" size="16" color="var(--text-secondary)"></i>
                        </div>
                    </div>
                </div>
            </header>

            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stock-info">
                        <span class="stat-label" id="cur-stock-name">神农集团</span>
                        <span class="stat-value" id="price-cur">--.--</span>
                    </div>
                    <span class="stat-change" id="change-cur">--.--%</span>
                </div>
                <div class="stat-card">
                    <div class="stock-info">
                        <span class="stat-label">上证指数</span>
                        <span class="stat-value" id="price-zs">--.--</span>
                    </div>
                    <span class="stat-change" id="change-zs">--.--%</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">成交活跃度</span>
                    <span class="stat-value" style="font-size: 1rem;" id="vol-cur">-- 手</span>
                </div>
            </div>

            <div class="chart-box">
                <div class="chart-title"><i data-lucide="layers" size="16"></i> 同步日K线与成交量对比 (MA5/10/20/30)</div>
                <div id="candle-chart" style="height: 1100px;"></div>
            </div>

            <div class="chart-box">
                <div class="chart-title"><i data-lucide="zap" size="16"></i> 今日分时走势相对强度对标</div>
                <div id="intraday-chart" style="height: 350px;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- High Fidelity UI Sound Engine ---
        const AudioFX = {
            ctx: null,
            enabled: localStorage.getItem('sound-enabled') !== 'false',
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play(type) {
                if (!this.enabled) return;
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;
                if (type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now);
                    osc.frequency.exponentialRampToValueAtTime(440, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'switch') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.exponentialRampToValueAtTime(880, now + 0.15);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15);
                } else if (type === 'hover') {
                    osc.frequency.setValueAtTime(1200, now);
                    gain.gain.setValueAtTime(0.02, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.05);
                    osc.start(now); osc.stop(now + 0.05);
                }
            }
        };

        // Sound Toggle Handler
        setTimeout(() => {
            const sToggle = document.getElementById('sound-toggle');
            if (!AudioFX.enabled) sToggle.classList.add('muted');
            sToggle.onclick = () => {
                AudioFX.init();
                if (AudioFX.ctx.state === 'suspended') AudioFX.ctx.resume();
                AudioFX.enabled = !AudioFX.enabled;
                localStorage.setItem('sound-enabled', AudioFX.enabled);
                sToggle.classList.toggle('muted');
                if (AudioFX.enabled) AudioFX.play('switch');
            };

            // 首次用户交互时解除音频挂起状态
            document.addEventListener('click', () => {
                AudioFX.init();
                if (AudioFX.ctx && AudioFX.ctx.state === 'suspended') AudioFX.ctx.resume();
            }, { once: true });
        }, 100);

        // --- Theme & Fullscreen Logic ---
        function changeTheme(theme, el) {
            AudioFX.play('switch');
            document.documentElement.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-dot').forEach(dot => dot.classList.remove('active'));
            el.classList.add('active');
            localStorage.setItem('stock-dashboard-theme', theme);

            // 稍后重绘图表以适配颜色
            setTimeout(() => {
                candleChart.resize();
                intradayChart.resize();
            }, 100);
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('stock-dashboard-theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.querySelectorAll('.theme-dot').forEach(dot => {
                if (dot.title === (savedTheme === 'dark' ? '极客黑' : (savedTheme === 'light' ? '明亮白' : (savedTheme === 'gold' ? '土豪金' : '祖母绿')))) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        document.getElementById('fs-toggle').addEventListener('click', () => {
            AudioFX.play('switch');
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        });

        document.addEventListener('fullscreenchange', () => {
            const icon = document.querySelector('#fs-toggle i');
            if (document.fullscreenElement) {
                icon.setAttribute('data-lucide', 'minimize');
            } else {
                icon.setAttribute('data-lucide', 'maximize');
            }
            lucide.createIcons();
            setTimeout(() => { candleChart.resize(); intradayChart.resize(); }, 100);
        });

        lucide.createIcons();

        // --- Sidebar Toggle Logic ---
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            AudioFX.play('switch');
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');

            // 持续重绘图表以适配过渡动画
            let count = 0;
            const resizeTimer = setInterval(() => {
                candleChart.resize();
                intradayChart.resize();
                if (++count > 35) clearInterval(resizeTimer);
            }, 10);
        });

        // Initial state
        let currentStock = { id: '1.605296', name: '神农集团' }; // Default
        const ZS_ID = '1.000001';
        let allStocks = [];

        const candleChart = echarts.init(document.getElementById('candle-chart'));
        const intradayChart = echarts.init(document.getElementById('intraday-chart'));

        window.addEventListener('resize', () => { candleChart.resize(); intradayChart.resize(); });

        async function getJSON(url) {
            try { const res = await fetch(url); return await res.json(); } catch (e) { return null; }
        }

        // --- 1. Stock List Functions (Infinite Scroll) ---
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;

        function fetchStockList(isNextPage = false) {
            if (isLoading || !hasMore) return;
            isLoading = true;

            if (!isNextPage) {
                currentPage = 1;
                allStocks = [];
                hasMore = true;
                document.getElementById('stock-list').innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">加载行情中...</div>';
            }

            const script = document.createElement('script');
            // 每次加载 100 条，减少单次渲染压力
            script.src = `https://push2.eastmoney.com/api/qt/clist/get?pn=${currentPage}&pz=100&po=1&np=1&fltt=2&invt=2&fid=f3&fs=m:0+t:6,m:0+t:80,m:1+t:2,m:1+t:23&fields=f2,f3,f12,f13,f14&cb=handleStockList&_=${Date.now()}`;
            script.onerror = () => {
                isLoading = false;
                if (!isNextPage) document.getElementById('stock-list').innerHTML = `<div style="padding:2rem;text-align:center;color:var(--up-color);">网络异常，请重试</div>`;
            };
            document.body.appendChild(script);
            script.onload = () => script.remove();
        }

        window.handleStockList = function (res) {
            isLoading = false;
            const container = document.getElementById('stock-list');
            if (res?.data?.diff) {
                const rawData = Array.isArray(res.data.diff) ? res.data.diff : Object.values(res.data.diff);
                const processed = rawData.map(s => ({
                    ...s,
                    f3: parseFloat(s.f3) || 0,
                    f2: s.f2 === '-' ? '-' : parseFloat(s.f2)
                }));

                if (currentPage === 1) allStocks = processed;
                else allStocks = [...allStocks, ...processed];

                if (processed.length < 100) hasMore = false;
                renderStockList(allStocks);
                currentPage++;
            } else {
                hasMore = false;
                if (currentPage === 1) container.innerHTML = `<div style="padding:2rem;text-align:center;color:var(--text-secondary);">未发现异动股票</div>`;
            }
        };

        // 监听滚动，实现触底自动加载
        document.getElementById('stock-list').addEventListener('scroll', function (e) {
            const { scrollTop, scrollHeight, clientHeight } = e.target;
            if (scrollTop + clientHeight >= scrollHeight - 300) { fetchStockList(true); }
        });

        function renderStockList(list) {
            const container = document.getElementById('stock-list');
            container.innerHTML = list.map(s => {
                const fullId = `${s.f13}.${s.f12}`;
                const isActive = fullId === currentStock.id ? 'active' : '';
                const color = s.f3 > 0 ? 'up' : s.f3 < 0 ? 'down' : 'neutral';
                const sign = s.f3 > 0 ? '+' : '';
                const priceDisplay = (typeof s.f2 === 'number') ? s.f2.toFixed(2) : '--';
                const pctDisplay = (typeof s.f3 === 'number') ? s.f3.toFixed(2) : '--';

                // 市场识别逻辑
                let mktName = '深';
                let mktClass = 'mkt-sz';
                if (s.f13 === 1) {
                    mktName = '沪';
                    mktClass = 'mkt-sh';
                } else if (s.f12.startsWith('8') || s.f12.startsWith('43') || s.f12.startsWith('92')) {
                    mktName = '京';
                    mktClass = 'mkt-bj';
                }

                const itemClass = mktClass === 'mkt-sh' ? 'item-sh' : (mktClass === 'mkt-sz' ? 'item-sz' : 'item-bj');

                return `
                    <div class="stock-item ${isActive} ${itemClass}" onclick="selectStock('${fullId}', '${s.f14}')">
                        <div class="stock-info">
                            <div class="stock-name-row">
                                <span class="stock-name">${s.f14}</span>
                                <span class="mkt-badge ${mktClass}">${mktName}</span>
                            </div>
                            <span class="stock-code">${s.f12}</span>
                        </div>
                        <div style="text-align:right">
                            <div class="stock-price ${color}">${priceDisplay}</div>
                            <div class="stock-pct ${color}">${sign}${pctDisplay}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectStock(id, name) {
            AudioFX.play('click');
            currentStock = { id, name };
            document.getElementById('main-title').innerText = `${name} 对标分析`;
            document.getElementById('cur-stock-name').innerText = name;
            renderStockList(allStocks); // Refresh active state
            updateAll();
        }

        document.getElementById('stock-search').addEventListener('input', (e) => {
            const val = e.target.value.trim().toLowerCase();
            if (!val) {
                renderStockList(allStocks);
                return;
            }
            const filtered = allStocks.filter(s => {
                // 支持代码搜索
                if (s.f12.includes(val)) return true;
                // 支持名称、拼音、简拼模糊搜索
                return PinyinMatch.match(s.f14 || '', val);
            });
            renderStockList(filtered);
        });

        // --- 2. Data Update Functions ---
        async function updateStats() {
            const curUrl = `https://push2.eastmoney.com/api/qt/stock/get?secid=${currentStock.id}&fields=f58,f43,f170,f47`;
            const zsUrl = `https://push2.eastmoney.com/api/qt/stock/get?secid=${ZS_ID}&fields=f43,f170`;
            const [curRes, zsRes] = await Promise.all([getJSON(curUrl), getJSON(zsUrl)]);

            if (curRes?.data) {
                const d = curRes.data;
                const price = (d.f43 / 100).toFixed(2);
                const pct = (d.f170 / 100).toFixed(2);
                document.getElementById('price-cur').innerText = price;
                document.getElementById('change-cur').innerText = (pct > 0 ? '+' : '') + pct + '%';
                document.getElementById('change-cur').className = 'stat-change ' + (pct > 0 ? 'up' : 'down');
                document.getElementById('vol-cur').innerText = (d.f47).toLocaleString() + ' 手';
            }
            if (zsRes?.data) {
                const d = zsRes.data;
                document.getElementById('price-zs').innerText = (d.f43 / 100).toFixed(2);
                document.getElementById('change-zs').innerText = (d.f170 > 0 ? '+' : '') + (d.f170 / 100).toFixed(2) + '%';
                document.getElementById('change-zs').className = 'stat-change ' + (d.f170 > 0 ? 'up' : 'down');
            }
            document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
        }

        async function updateCandle() {
            const common = `fields1=f1,f2&fields2=f51,f52,f53,f54,f55,f56,f59&klt=101&fqt=1&end=20500101&lmt=1000&ut=fa5fd1943c7b386f172d6893dbf24fe0`;
            const [curRes, zsRes] = await Promise.all([
                getJSON(`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${currentStock.id}&${common}`),
                getJSON(`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${ZS_ID}&${common}`)
            ]);
            if (!curRes?.data || !zsRes?.data) return;

            const parse = (k) => k.map(x => {
                const p = x.split(',');
                return { date: p[0], o: parseFloat(p[1]), c: parseFloat(p[2]), h: parseFloat(p[3]), l: parseFloat(p[4]), v: parseFloat(p[5]), pct: parseFloat(p[6]) };
            });

            const curRaw = parse(curRes.data.klines);
            const zsRaw = parse(zsRes.data.klines);
            const dates = [...new Set([...curRaw.map(d => d.date), ...zsRaw.map(d => d.date)])].sort();

            const align = (raw) => dates.map(d => {
                const found = raw.find(x => x.date === d);
                return found ? found : { o: null, c: null, h: null, l: null, v: 0, pct: 0 };
            });

            const curD = align(curRaw);
            const zsD = align(zsRaw);

            const calculateMA = (data, dayCount) => {
                let result = [];
                for (let i = 0, len = data.length; i < len; i++) {
                    if (i < dayCount - 1) { result.push('-'); continue; }
                    let sum = 0;
                    for (let j = 0; j < dayCount; j++) { sum += data[i - j].c; }
                    result.push(+(sum / dayCount).toFixed(2));
                }
                return result;
            };

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis', axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(23,27,38,0.95)', borderColor: 'rgba(255,255,255,0.1)', textStyle: { color: '#fff' },
                    formatter: function (params) {
                        const idx = params[0].dataIndex;
                        const c = curD[idx], z = zsD[idx];
                        const formatPct = (p) => `<span style="color:${p >= 0 ? '#f43f5e' : '#10b981'}">${p >= 0 ? '+' : ''}${p.toFixed(2)}%</span>`;
                        return `
                        <div style="padding:4px; font-size:12px;">
                            <div style="margin-bottom:8px; font-weight:bold;">${params[0].name}</div>
                            <div style="border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:4px; margin-bottom:4px;">
                                <div style="color:${params[0].color}">${currentStock.name}</div>
                                收: ${c.c?.toFixed(2) || '-'} 幅: ${formatPct(c.pct)}
                            </div>
                            <div>
                                <div style="color:#94a3b8">上证指数</div>
                                收: ${z.c?.toFixed(2) || '-'} 幅: ${formatPct(z.pct)}
                            </div>
                        </div>`;
                    }
                },
                axisPointer: { link: { xAxisIndex: 'all' } },
                grid: [
                    { left: 50, right: 30, top: '2%', height: '37%' },
                    { left: 50, right: 30, top: '40%', height: '7%' },
                    { left: 50, right: 30, top: '51%', height: '37%' },
                    { left: 50, right: 30, top: '89%', height: '7%' }
                ],
                xAxis: [0, 1, 2, 3].map(i => ({ type: 'category', data: dates, gridIndex: i, axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }, axisLabel: { show: i === 3, color: '#64748b' } })),
                yAxis: [
                    { scale: true, gridIndex: 0, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
                    { scale: true, gridIndex: 1, splitLine: { show: false }, axisLabel: { show: false } },
                    { scale: true, gridIndex: 2, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
                    { scale: true, gridIndex: 3, splitLine: { show: false }, axisLabel: { show: false } }
                ],
                dataZoom: [
                    { type: 'inside', xAxisIndex: [0, 1, 2, 3], start: 95, end: 100 },
                    { show: true, xAxisIndex: [0, 1, 2, 3], type: 'slider', bottom: '0%', height: 16, start: 95, end: 100 }
                ],
                series: [
                    {
                        name: 'K线', type: 'candlestick',
                        data: curD.map(d => [d.o, d.c, d.l, d.h]),
                        itemStyle: { color: '#f43f5e', color0: '#10b981' }
                    },
                    { name: 'MA5', type: 'line', data: calculateMA(curD, 5), smooth: true, lineStyle: { opacity: 0.5, width: 1 }, showSymbol: false },
                    { name: 'MA20', type: 'line', data: calculateMA(curD, 20), smooth: true, lineStyle: { opacity: 0.5, width: 1 }, showSymbol: false },
                    { name: '成交量', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: curD.map(d => ({ value: d.v, itemStyle: { color: d.c >= d.o ? '#f43f5e' : '#10b981' } })) },
                    {
                        name: '上证K', type: 'candlestick', xAxisIndex: 2, yAxisIndex: 2,
                        data: zsD.map(d => [d.o, d.c, d.l, d.h]),
                        itemStyle: { color: '#f43f5e', color0: '#10b981' }
                    },
                    { name: 'MA5', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: calculateMA(zsD, 5), smooth: true, lineStyle: { opacity: 0.5, width: 1 }, showSymbol: false },
                    { name: 'MA20', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: calculateMA(zsD, 20), smooth: true, lineStyle: { opacity: 0.5, width: 1 }, showSymbol: false },
                    { name: '成交量', type: 'bar', xAxisIndex: 3, yAxisIndex: 3, data: zsD.map(d => ({ value: d.v, itemStyle: { color: d.c >= d.o ? '#f43f5e' : '#10b981' } })) }
                ]
            };

            candleChart.setOption(option);
            updateExLines();
        }

        function updateExLines() {
            const opt = candleChart.getOption();
            if (!opt.series || !opt.series[0].data) return;

            const dz = opt.dataZoom[0];
            const data = opt.series[0].data;

            // 使用 startValue/endValue 获得像素级精确的可见区间索引
            let start = dz.startValue !== undefined ? dz.startValue : Math.floor(dz.start * data.length / 100);
            let end = dz.endValue !== undefined ? dz.endValue : Math.ceil(dz.end * data.length / 100);

            const visibleData = data.slice(Math.max(0, start), Math.min(data.length, end + 1));
            if (visibleData.length === 0) return;

            let maxVal = -Infinity, minVal = Infinity;
            visibleData.forEach(d => {
                const high = d[3], low = d[2];
                if (high !== null && high > maxVal) maxVal = high;
                if (low !== null && low < minVal) minVal = low;
            });

            if (maxVal === -Infinity) return;

            candleChart.setOption({
                animation: false,
                series: [{
                    name: 'K线',
                    markLine: {
                        symbol: ['none', 'none'],
                        label: {
                            position: 'end',
                            fontSize: 11,
                            fontWeight: 'bold',
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: [4, 6],
                            borderRadius: 4,
                            distance: 15
                        },
                        lineStyle: { type: 'dashed', width: 1.5, opacity: 0.8 },
                        data: [
                            { yAxis: maxVal, label: { formatter: '视野最高: {c}', color: '#ff3333' }, lineStyle: { color: '#ff3333' } },
                            { yAxis: minVal, label: { formatter: '视野最低: {c}', color: '#00ff66' }, lineStyle: { color: '#00ff66' } }
                        ],
                        z: 20 // 确保在均线和蜡烛图上方
                    }
                }]
            });
        }

        candleChart.on('dataZoom', updateExLines);

        async function updateIntraday() {
            const [curRes, zsRes] = await Promise.all([
                getJSON(`https://push2.eastmoney.com/api/qt/stock/trends/get?secid=${currentStock.id}&fields2=f51,f52,f53&ndays=1`),
                getJSON(`https://push2.eastmoney.com/api/qt/stock/trends/get?secid=${ZS_ID}&fields2=f51,f52,f53&ndays=1`)
            ]);
            if (!curRes?.data || !zsRes?.data) return;
            const parse = (d) => d.trends.map(t => ({ time: t.split(',')[0].split(' ')[1], pct: ((parseFloat(t.split(',')[2]) - d.prePrice) / d.prePrice * 100).toFixed(2) }));
            const curP = parse(curRes.data);
            const zsP = parse(zsRes.data);
            intradayChart.setOption({
                backgroundColor: 'transparent', tooltip: { trigger: 'axis' }, legend: { textStyle: { color: '#94a3b8' }, top: 0 },
                grid: { top: 30, left: 50, right: 30, bottom: 30 },
                xAxis: { type: 'category', data: curP.map(x => x.time), axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } } },
                yAxis: { type: 'value', axisLabel: { formatter: '{value}%' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } } },
                series: [
                    { name: currentStock.name, type: 'line', data: curP.map(x => x.pct), smooth: true, showSymbol: false, lineStyle: { width: 2, color: '#3b82f6' } },
                    { name: '上证指数', type: 'line', data: zsP.map(x => x.pct), smooth: true, showSymbol: false, lineStyle: { width: 1, color: '#f43f5e', type: 'dashed' } }
                ]
            });
        }

        async function updateAll() {
            await updateStats();
            await updateCandle();
            await updateIntraday();
        }

        // 跳转至最新
        document.getElementById('latest-toggle').addEventListener('click', () => {
            AudioFX.play('click');
            const options = candleChart.getOption();
            if (options.dataZoom && options.dataZoom[0]) {
                const dz = options.dataZoom[0];
                const range = dz.end - dz.start;
                candleChart.dispatchAction({
                    type: 'dataZoom',
                    start: 100 - range,
                    end: 100
                });
            }
        });

        (async () => {
            await fetchStockList();
            // 初始化时手动触发默认股票的选择逻辑，确保 UI 同步
            selectStock(currentStock.id, currentStock.name);
            setInterval(() => { updateStats(); updateIntraday(); }, 30000);
            lucide.createIcons(); // 确保所有新添加的图标被渲染
        })();
    </script>
</body>

</html>